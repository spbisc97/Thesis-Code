% Uses Internatonal Standard Atmosphere model for height lower than 20 km
% and MSISE-90 Model of Earth's Upper Atmosphere for heights up to 900 km
% INPUTS: 
% (1) geopotential height [km] from 20 to 900 km
% (2) solar activity, set 1:low, 2:medium, 3:high 
% OUTPUTS: 
% (1) air density [kg/m^3]

function rho=atmosisa2(height,solar_intensity)
%#codegen
%% Input processing
h=height;
index=solar_intensity;
%% Polyfit of MSISE-90 data
MSISEtab=[
20   206.2085	9.48E-02	5.62E+03	28.9502 	206.2085	9.49E-02	5.62E+03	28.9502     206.2085	9.41E-02	5.57E+03	28.9502;
40	257.6979	4.07E-03	3.01E+02	28.9502     257.6979	4.07E-03	3.02E+02	28.9502     257.6979	4.04E-03	2.99E+02	28.9502;
60	244.1212	3.31E-04	2.32E+01	28.9502     244.1212	3.31E-04	2.32E+01	28.9502     244.1212	3.28E-04	2.30E+01	28.9502;
80	203.1065	1.69E-05	9.81E-01	29.1353     196.3636	1.68E-05	9.45E-01	29.0175     172.2146	1.68E-05	8.42E-01	28.5290;
100	168.7219	5.77E-07	2.89E-02	28.0036     184.0160	5.08E-07	2.81E-02	27.7137     297.3338	2.78E-07	2.63E-02	26.1997;
120	356.8669	1.70E-08	1.92E-03	26.3948     374.9715	1.80E-08	2.17E-03	25.8745     430.8385	2.34E-08	3.55E-03	23.6456;
140	545.8594	2.96E-09	5.37E-04	25.0665     635.5703	3.26E-09	7.03E-04	24.5349     875.9174	4.93E-09	1.61E-03	22.3209;
160	630.0652	9.65E-10	2.13E-04	23.7884     787.5532	1.18E-09	3.31E-04	23.4225 	1143.5426	2.23E-09	9.90E-04	21.4577;
180	667.8662	3.90E-10	9.62E-05	22.5037     877.6729	5.51E-10	1.80E-04	22.4106     1314.3427	1.28E-09	6.76E-04	20.7706;
200	684.9187	1.75E-10	4.70E-05	21.2516     931.2806	2.91E-10	1.05E-04	21.4734 	1423.6469	8.28E-10	4.86E-04	20.1836;
220	692.6487	8.47E-11	2.43E-05	20.0935     963.2701	1.66E-10	6.44E-05	20.6108     1493.7864	5.69E-10	3.60E-04	19.6664;
240	696.1697	4.31E-11	1.31E-05	19.0789     982.4191	9.91E-11	4.09E-05	19.8292     1538.9154	4.08E-10	2.72E-04	19.2046;
260	697.7811	2.30E-11	7.31E-06	18.2300     993.9173	6.16E-11	2.66E-05	19.1337     1568.0294	3.00E-10	2.08E-04	18.7901;
280	698.5220	1.27E-11	4.20E-06	17.5402     1000.8427	3.94E-11	1.77E-05	18.5256     1586.8613	2.25E-10	1.61E-04	18.4178;
300	698.8644	7.22E-12	2.47E-06	16.9830     1005.0267	2.58E-11	1.20E-05	18.0015     1599.0743	1.71E-10	1.26E-04	18.0839;
320	699.0233	4.21E-12	1.48E-06	16.5214     1007.5620	1.72E-11	8.20E-06	17.5537     1607.0154	1.32E-10	9.93E-05	17.7852;
340	699.0973	2.50E-12	9.01E-07	16.1147     1009.1030	1.16E-11	5.69E-06	17.1721     1612.1920	1.03E-10	7.86E-05	17.5186;
360	699.1320	1.51E-12	5.57E-07	15.7219     1010.0423	7.99E-12	3.98E-06	16.8449     1615.5751	8.05E-11	6.26E-05	17.2812;
380	699.1483	9.20E-13	3.50E-07	15.3028     1010.6166	5.55E-12	2.81E-06	16.5597     1617.7916	6.35E-11	5.01E-05	17.0699;
400	699.1561	5.68E-13	2.23E-07	14.8185 	1010.9688	3.89E-12	2.01E-06	16.3044     1619.2476	5.04E-11	4.02E-05	16.8818;
420	699.1597	3.54E-13	1.45E-07	14.2332 	1011.1853	2.75E-12	1.44E-06	16.0669     1620.2062	4.02E-11	3.25E-05	16.7142;
440	699.1615	2.23E-13	9.61E-08	13.5181     1011.3190	1.96E-12	1.04E-06	15.8360     1620.8390	3.23E-11	2.63E-05	16.5643;
460	699.1623	1.42E-13	6.54E-08	12.6581     1011.4014	1.40E-12	7.55E-07	15.6008     1621.2577	2.60E-11	2.13E-05	16.4297;
480	699.1627	9.20E-14	4.59E-08	11.6594     1011.4526	1.01E-12	5.53E-07	15.3508     1621.5354	2.10E-11	1.73E-05	16.3079;
500	699.1629	6.03E-14	3.32E-08	10.5547     1011.4845	7.30E-13	4.07E-07	15.0760 	1621.7200	1.70E-11	1.42E-05	16.1967;
520	699.1630	4.03E-14	2.49E-08	9.4006      1011.5043	5.31E-13	3.03E-07	14.7669     1621.8430	1.38E-11	1.16E-05	16.0940;
540	699.1630	2.75E-14	1.94E-08	8.2657      1011.5168	3.88E-13	2.27E-07	14.4148     1621.9253	1.13E-11	9.50E-06	15.9980;
560	699.1631	1.93E-14	1.55E-08	7.2141      1011.5245	2.85E-13	1.71E-07	14.0125     1621.9803	9.21E-12	7.81E-06	15.9067;
580	699.1631	1.39E-14	1.28E-08	6.2904      1011.5294	2.11E-13	1.31E-07	13.5547     1622.0172	7.55E-12	6.44E-06	15.8187;
600	699.1631	1.03E-14	1.09E-08	5.5149      1011.5325	1.56E-13	1.01E-07	13.0389     1622.0421	6.20E-12	5.31E-06	15.7321;
620	699.1631	7.90E-15	9.40E-09	4.8864      1011.5345	1.17E-13	7.89E-08	12.4665     1622.0588	5.10E-12	4.40E-06	15.6457;
640	699.1631	6.24E-15	8.27E-09	4.3891      1011.5357	8.79E-14	6.24E-08	11.8428 	1622.0702	4.20E-12	3.65E-06	15.5578;
660	699.1631	5.06E-15	7.36E-09	4.0012      1011.5365	6.65E-14	5.01E-08	11.1779     1622.0778	3.47E-12	3.03E-06	15.4672;
680	699.1631	4.21E-15	6.62E-09	3.6999      1011.5370	5.08E-14	4.07E-08	10.4854     1622.0830	2.88E-12	2.52E-06	15.3725;
700	699.1631	3.58E-15	6.00E-09	3.4648      1011.5374	3.91E-14	3.36E-08	9.7818      1622.0865	2.38E-12	2.11E-06	15.2723;
720	699.1631	3.09E-15	5.48E-09	3.2789      1011.5375	3.04E-14	2.82E-08	9.0847      1622.0890	1.98E-12	1.76E-06	15.1653;
740	699.1631	2.70E-15	5.02E-09	3.1289      1011.5377	2.39E-14	2.39E-08	8.4111      1622.0906	1.65E-12	1.48E-06	15.0503;
760	699.1631	2.39E-15	4.63E-09	3.0049      1011.5377	1.90E-14	2.06E-08	7.7753      1622.0918	1.37E-12	1.24E-06	14.9260;
780	699.1631	2.13E-15	4.28E-09	2.8996      1011.5378	1.53E-14	1.79E-08	7.1884      1622.0925	1.15E-12	1.05E-06	14.7912;
800	699.1631	1.91E-15	3.96E-09	2.8075      1011.5378	1.25E-14	1.58E-08	6.6572      1622.0930	9.59E-13	8.84E-07	14.6447;
820	699.1631	1.73E-15	3.68E-09	2.7249      1011.5378	1.03E-14	1.40E-08	6.1849      1622.0934	8.04E-13	7.48E-07	14.4854;
840	699.1631	1.56E-15	3.43E-09	2.6492      1011.5379	8.64E-15	1.26E-08	5.7711      1622.0936	6.74E-13	6.36E-07	14.3123;
860	699.1631	1.42E-15	3.21E-09	2.5784      1011.5379	7.32E-15	1.14E-08	5.4132      1622.0939	5.67E-13	5.42E-07	14.1244;
880	699.1631	1.30E-15	3.00E-09	2.5113      1011.5379	6.28E-15	1.04E-08	5.1066      1622.0940	4.77E-13	4.63E-07	13.9210;
900	699.1631	1.18E-15	2.81E-09	2.4470      1011.5379	5.46E-15	9.47E-09	4.8460      1622.0940	4.03E-13	3.97E-07	13.7015];
%% Data processing
IND=3+4*(index-1);
if h<20 
    [T,a,P,rho]=atmosisa(h*1000);
end
if h>=20 && h<=900
    rho=interp1(MSISEtab(:,1),MSISEtab(:,IND),h);
end
if h>900
    rho=interp1(MSISEtab(:,1),MSISEtab(:,7),h,'linear','extrap');
    if rho<0
        rho=0;
    end
end